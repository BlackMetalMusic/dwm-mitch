diff -Narup 00_dmenu-3.6_history/dmenu.c 01_dmenu-3.6_fixemptylines/dmenu.c
--- 00_dmenu-3.6_history/dmenu.c	2008-04-16 21:34:55.000000000 +0200
+++ 01_dmenu-3.6_fixemptylines/dmenu.c	2008-04-16 21:34:55.000000000 +0200
@@ -185,8 +185,9 @@ writehistory(char *command) {
     if( (f = fopen(histfile, "w")) ) {
         fputs(command, f); fputc('\n', f);
         for(; i<HIST_SIZE && i<j; i++) {
-            if(strcmp(command, hist[i]) != 0) 
+	    if(strcmp(command, hist[i]) != 0) {
                 fputs(hist[i], f); fputc('\n', f);
+	    }
         }
         fclose(f);
         return 1;
@@ -205,7 +206,7 @@ readhistory (void) {
         return 0;
 
     if( (f = fopen(histfile, "r+")) ) {
-        while(fgets(buf, sizeof buf, f))  
+        while(fgets(buf, sizeof buf, f) && (hcnt < HIST_SIZE))  
             strncpy(hist[hcnt++], buf, (strlen(buf) <= 1024) ? strlen(buf): 1024 );
         fclose(f);
     }
